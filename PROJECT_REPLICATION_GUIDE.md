# 心率识别系统复刻指南

## 项目背景

本项目实现了一种基于远程光电容积描记术(rPPG)的非接触式心率检测系统，通过摄像头视频流检测面部皮肤颜色变化来实时估计心率，无需传感器与人体接触。系统采用深度学习皮肤语义分割、高级信号处理和实时性能优化等技术，提供准确、实时的心率监测功能。

## 技术栈要求

### 后端技术
- **Python 3.8+**
- **FastAPI** - 高性能异步Web框架
- **OpenCV** - 计算机视觉库，用于人脸检测
- **PyTorch** - 深度学习框架，用于皮肤分割
- **NumPy** - 数值计算库
- **SciPy** - 科学计算库，用于信号处理
- **PyWavelets** - 小波变换库，用于信号去噪
- **WebSocket** - 实时通信协议

### 前端技术
- **HTML5/CSS3** - 页面结构和样式
- **JavaScript (ES6+)** - 前端逻辑
- **Canvas API** - 信号可视化
- **WebSocket API** - 实时数据通信
- **Camera API** - 摄像头访问

### 硬件要求
- **摄像头** - 支持至少720p分辨率
- **CPU** - 至少4核心
- **内存** - 至少4GB
- **GPU** (可选) - 支持CUDA的GPU，用于加速皮肤分割

## 功能模块说明

### 1. 视频捕获模块
- 从摄像头获取实时视频流
- 支持不同分辨率和帧率
- 视频帧预处理和格式转换

### 2. 面部检测模块
- 使用OpenCV的Haar级联分类器检测人脸
- 多尺度人脸检测，支持不同距离的人脸
- 人脸坐标计算和边界框生成

### 3. 皮肤分割模块
- 使用UNet11深度学习模型分割皮肤像素
- 模型压缩和优化（JIT编译、量化）
- 图像预处理（对比度增强、光照归一化）
- 自适应阈值分割

### 4. 信号处理模块
- ROI（感兴趣区域）提取和处理
- 多ROI融合技术
- 环境光补偿
- 信号滤波（巴特沃斯带通滤波器）
- 小波变换去噪
- 卡尔曼滤波平滑

### 5. 心率估计模块
- FFT（快速傅里叶变换）频率分析
- 功率谱密度计算
- 心率峰值检测
- 心率平滑和异常值处理

### 6. WebSocket通信模块
- 实时视频帧传输
- 心率数据和状态更新
- 错误处理和重连机制

### 7. 前端界面模块
- 视频流显示
- 心率实时显示
- 信号质量可视化
- 历史数据记录
- 系统状态指示

## 实现步骤

### 步骤1: 项目初始化
1. 创建项目目录结构
2. 安装依赖包
3. 配置环境变量

### 步骤2: 后端服务实现
1. **FastAPI应用初始化**
   - 创建主应用实例
   - 配置CORS和静态文件服务

2. **皮肤分割模型集成**
   - 下载和部署UNet11预训练模型
   - 实现模型压缩和优化
   - 创建皮肤分割服务类

3. **面部检测实现**
   - 集成OpenCV Haar级联分类器
   - 实现多尺度人脸检测
   - 创建面部检测服务类

4. **信号处理实现**
   - 实现ROI提取和处理
   - 实现信号滤波和去噪
   - 创建rPPG信号处理服务类

5. **WebSocket路由实现**
   - 创建WebSocket端点
   - 实现视频帧处理和心率计算
   - 实现实时数据传输

### 步骤3: 前端应用实现
1. **HTML页面结构**
   - 创建主页面布局
   - 设计视频显示区域
   - 设计心率和信号显示区域

2. **JavaScript功能实现**
   - 实现摄像头访问和视频捕获
   - 实现WebSocket连接和数据处理
   - 实现信号可视化和心率显示

3. **CSS样式设计**
   - 响应式布局设计
   - 信号图表样式设计
   - 界面美观度优化

### 步骤4: 系统集成和测试
1. **前后端集成**
   - 配置前端WebSocket连接
   - 测试数据传输和处理

2. **系统测试**
   - 功能测试
   - 性能测试
   - 兼容性测试

3. **优化和调整**
   - 性能优化
   - 准确性调整
   - 用户体验优化

## 设计规范

### 代码规范
- **Python** - 遵循PEP 8规范
- **JavaScript** - 遵循ESLint标准
- **命名约定** - 清晰、一致的命名
- **注释** - 关键代码和算法添加详细注释

### 架构规范
- **模块化设计** - 清晰的模块划分和职责分离
- **服务导向** - 使用服务类封装核心功能
- **异步处理** - 利用FastAPI的异步特性
- **并行计算** - 使用线程池处理计算密集型任务

### 安全规范
- **输入验证** - 验证所有用户输入
- **错误处理** - 优雅处理错误，不暴露敏感信息
- **资源管理** - 正确管理摄像头和网络资源

## 性能指标

### 实时性指标
- **处理时间** - 每帧处理时间 < 400ms
- **延迟** - 心率显示延迟 < 1秒
- **帧率** - 至少15fps

### 准确性指标
- **心率误差** - 平均误差 < 5 BPM
- **信号质量** - 在不同光照条件下保持稳定
- **运动鲁棒性** - 对轻微头部运动有一定鲁棒性

### 资源使用指标
- **内存使用** - 峰值内存 < 2GB
- **CPU使用率** - 平均使用率 < 50%
- **网络带宽** - 视频流带宽 < 1Mbps

## 兼容性要求

### 浏览器兼容性
- **Chrome** - 最新版
- **Firefox** - 最新版
- **Safari** - 最新版
- **Edge** - 最新版

### 操作系统兼容性
- **Windows** - 10/11
- **macOS** - 10.15+
- **Linux** - Ubuntu 20.04+

### 摄像头兼容性
- **内置摄像头** - 支持大多数笔记本电脑内置摄像头
- **外置摄像头** - 支持USB外置摄像头
- **分辨率** - 支持720p及以上分辨率

## 测试标准

### 功能测试
1. **人脸检测测试**
   - 在不同距离、角度和光照条件下测试
   - 测试多人脸检测

2. **心率检测测试**
   - 与医疗级心率监测设备对比
   - 在不同运动状态下测试
   - 在不同光照条件下测试

3. **系统功能测试**
   - WebSocket连接稳定性
   - 前端界面响应性
   - 错误处理和恢复

### 性能测试
1. **实时性测试**
   - 测量每帧处理时间
   - 测量心率显示延迟
   - 测量系统稳定性

2. **资源使用测试**
   - 测量内存使用
   - 测量CPU使用率
   - 测量网络带宽使用

### 兼容性测试
1. **浏览器测试**
   - 在所有支持的浏览器中测试
   - 测试不同浏览器版本

2. **设备测试**
   - 在不同硬件配置的设备上测试
   - 测试不同摄像头质量

## 部署指南

### 开发环境部署
1. **克隆代码库**
2. **安装依赖** - `pip install -r requirements.txt`
3. **启动后端** - `uvicorn app.main:app --reload`
4. **启动前端** - `python -m http.server 3000`
5. **访问应用** - 打开浏览器访问 http://localhost:3000

### 生产环境部署
1. **构建前端** - 优化前端代码
2. **配置后端** - 禁用热重载，配置生产设置
3. **部署服务** - 使用Nginx作为反向代理
4. **监控系统** - 配置日志和监控

## 故障排除

### 常见问题
1. **摄像头无法访问**
   - 检查浏览器权限
   - 检查摄像头是否被其他应用占用

2. **人脸检测失败**
   - 检查光照条件
   - 调整摄像头角度
   - 确保面部在摄像头视野内

3. **心率检测不准确**
   - 确保面部与摄像头保持适当距离（30-60cm）
   - 减少头部运动
   - 确保环境光稳定

4. **系统运行缓慢**
   - 降低摄像头分辨率
   - 关闭其他占用系统资源的应用
   - 考虑使用GPU加速

### 调试工具
- **后端日志** - 服务器控制台输出
- **前端控制台** - 浏览器开发者工具
- **信号质量指标** - 系统内置的信号质量监测

## 项目结构

```
├── backend/
│   ├── app/
│   │   ├── services/
│   │   │   ├── face_recognition.py   # 面部检测和皮肤分割
│   │   │   ├── rppg.py              # rPPG信号处理
│   │   │   └── websocket.py         # WebSocket服务
│   │   ├── routes/
│   │   │   └── websocket_routes.py  # WebSocket路由
│   │   └── main.py                  # 应用入口
│   ├── rPPG/
│   │   ├── FaceSeg.py               # 皮肤分割模型
│   │   └── models/                  # 深度学习模型
│   └── requirements.txt             # 依赖配置
├── frontend/
│   ├── index.html                   # 主页面
│   ├── css/
│   │   └── styles.css              # 样式文件
│   ├── js/
│   │   ├── app.js                  # 应用逻辑
│   │   ├── camera.js               # 摄像头管理
│   │   ├── websocket.js            # WebSocket通信
│   │   └── ui.js                   # 界面管理
│   └── history.html                 # 历史记录页面
└── PROJECT_REPLICATION_GUIDE.md     # 复刻指南
```

## 技术文档

### 核心算法
1. **皮肤分割** - UNet11深度学习模型
2. **信号提取** - POS算法
3. **信号处理** - 小波变换、卡尔曼滤波
4. **心率计算** - FFT频率分析

### 关键技术点
1. **深度学习皮肤语义分割** - 提高ROI选择准确性
2. **多ROI融合** - 降低噪声干扰
3. **环境光补偿** - 提高在不同光照条件下的准确性
4. **自适应参数调整** - 根据信号质量自动调整系统参数
5. **模型压缩** - 使用JIT编译和量化提高实时性能
6. **多线程并行处理** - 提高处理速度

## 未来扩展

### 潜在功能扩展
1. **呼吸率检测** - 基于胸部运动分析
2. **情绪分析** - 基于心率变异性
3. **健康建议** - 基于长期心率数据
4. **云端存储** - 心率数据云同步
5. **移动应用** - 开发移动端应用

### 技术改进
1. **更先进的皮肤分割模型** - 提高分割准确性
2. **3D面部建模** - 提高对角度变化的鲁棒性
3. **边缘计算** - 减少云端依赖
4. **联邦学习** - 保护用户隐私的模型改进

## 总结

本项目提供了一个完整的非接触式心率检测系统，结合了最新的计算机视觉、深度学习和信号处理技术。通过本指南，您应该能够准确复现整个项目，并根据需要进行扩展和改进。系统的模块化设计和详细文档使其易于理解和维护，为未来的功能扩展和技术改进提供了良好的基础。